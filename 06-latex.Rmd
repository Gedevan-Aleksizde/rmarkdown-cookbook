# LaTeX 出力 {#latex-output}

多くの著者にとって作品の主な出力は PDF レポートで, この出力では強力な LaTex のスタイル設定を活用できます. この章では, LaTeX コードやパッケージをプリアンブルに含めることや, カスタム LaTeX レンプレートの使用, ヘッダとフッタの追加, 図を分割して生成する方法, 生の LaTeX コードを文書の本文に書く方法, といったPDFレポートのカスタマイズに使えるアプローチについて議論します.

ただし, 始める前に注意しておきたいことがあります.R Markdown の恩恵の1つは単一のソース文書から複数のフォーマットの文書を生成できるということです. あなたの作品を単一の出力に対して仕立て上げるこにとよって, その出力フォーマット単体の見た目やパフォーマンスは向上するかもしれませんが, それはこの移植性を犠牲にすることでもあります. この問題は LaTeX に限ったことでなく. 他の出力フォーマットでも同様です.

## プリアンブルに LaTeX コードを追加する {#latex-preamble}

LaTeX 文書\index{LaTeX}の一般的な構造はこのようになっています.

```tex
\documentclass{article}
% preamble
\begin{document}
% body
\end{document}
```

これは文書クラスを `\documentclass{}` で宣言し, 必要に応じて特定の LaTeX パッケージを読み込んだり特定のオプションをプリアンブルで設定し, そして `\begin{document}` の後で文書の本文を書き始めています. Markdown 文書はほとんどがこの文書の本文に対応します.

プリアンブルになにか追加したい時, `pdf_document`\index{出力オプション!includes} `include` を使わねばなりません. このオプションは3つのサブオプションを持ちます. `in_header`, `before_body`, そして `after_body` です. これらは1つ以上のファイルパスを指定できます. `in_header` に指定されたファイルはプリアンブルに追加されます.  `before_body` と `after_body` に指定されたファイルはそれぞれ本文の前と後に追加されます.

例えば以下はテキスト内のハイパーリンクを脚注に変えるトリックです. PDF 出力された文書が紙に印刷されたものだと, 読者は紙面のリンク (`\href{URL}{text}` で生成されたもの) をクリックすることはできませんが, 脚注の URL を見ることはできるのでこのトリックは役に立ちます. このトリックはテキストと URL の両方を表示します.

```tex
% あなたはレンダリング前に \href のコピーを保存したいかもしれない
% \let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
```

あるファイル名 , 例えば `preamble.tex` 内に上記のコードを保存できます. それからプリアンブルにこれを読み込んでください.

```yaml
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
```

このトリックは実際には自分で実装しなくてもよく, Pandoc のデフォルトのテンプレート (\@ref(latex-variables)節参照) に組み込まれた機能である YAML オプション `links-as-notes` を `true``\index{YAML!links-as-notes}にすることで簡単にできます.


コードをプリアンブルに追加する別の方法は,  YAML フロントマター\index{YAML!header-includes} の `header-includes` フィールドに直接与えることです. \@ref(latex-logo)節でその例を紹介しています. `header-includes` を使う利点は R Markdown 文書1つの内部に全てを含められることです. しかしあなたのレポートを複数の出力フォーマットに生成しなければならないなら, `includes` を使う方法をお薦めします. `header-includes` は無条件であり, 非 LaTeX 出力の文書に対しても読み込まれてしまうからです. 比較として, `includes` オプションは `pdf_document` フォーマットにのみ適用されます.

## LaTeX 出力の Pandoc オプション {#latex-variables}

LaTeX 出力に対してデフォルトの Pandoc を使うなら, PDF 出力の文書の見た目を調整するいくつかのオプションがあります. いくつかのオプションの例を以下に挙げていきます. 完全なリストは https://pandoc.org/MANUAL.html#variables-for-latex で見ることができます.

```yaml
documentclass: book
classoption:
  - twocolumn
  - landscape
papersize: a5
linestretch: 1.5
fontsize: 12pt
links-as-notes: true
```

あなたが LaTeX にある程度詳しいなら, これらのオプションの意味は明らかでしょう. `documentclass` オプション\index{YAML!documentclass} は, 例えば `article`, `book`, `report` などの文書クラスを設定します. `classoption` は文書クラスに与えるオプションのリストで, 例えば二段組の文書を作りたいなら `twocolumn` オプション,^[このオプションは文書全体を変更しますが, 特定の位置から再度一段組に戻したいのなら, そこに `\onecolumn` コマンドを挿入することになるでしょう. 二段組モードを続けたいなら `\twocolumn` を挿入します.], 横置きレイアウトにするなら `landscape` オプション (デフォルトでは縦置き (portrait) レイアウト) があります. `papersize`\index{YAML!papersize} オプションは `a4`, `paper`, `a5` といった用紙サイズを設定します. `linestretch`\index{YAML!linestretch} オプションは行間を設定します. `fontsize`\index{YAML!fontsize} オプションはフォントサイズを `10pt`, `11pt`, `12pt` というふうに設定します. `links-as-notes` オプションはテキスト内のリンクを脚注に置き換えます. 紙に印刷する際には読者は紙面上のリンクをクリックできませんが, 脚注の URL を見ることができるので便利です.

フォントの変更は少しトリッキーです. どの LaTeX エンジンを使っているかに依存します. LaTeX ベースの出力フォーマットで大抵の場合デフォルトである `pdflatex`\index{pdflatex} を使っているのなら^[**訳注**: 日本語文書を **pdflatex** で出力することは全く不可能というわけではありませんが, 技術的制約が多いため LaTeX に慣れている方以外にはお薦めしません.], 読み込む LaTeX フォントパッケージを選択するために  `fontfamily` オプションを使ってください. 例えばこのように.

```yaml
fontfamily: accanthis
output:
  pdf_document: 
    latex_engine: pdflatex
```

これで文書に [Accanthis](https://tug.org/FontCatalogue/accanthis/) フォントが使われます. 他の多数の LaTeX フォントパッケージのリストは You may see https://tug.org/FontCatalogue/  で見ることができます. LaTeX ディストリビューションに TinyTeX をお使いで, フォントパッケージがインストールされていないならば,   文書がコンパイルされる際に自動でインストールされるはずです(\@ref(install-latex)節参照).

LaTeX エンジンに `xelatex` または `lualatex` を使っているなら, ローカルのコンピュータで使用可能なフォントから選ぶことができ, LaTeX パッケージの追加インストールはしなくともよいです. YAML オプション `mainfont`\index{YAML!mainfont}, `sansfont`\index{YAML!sansfont}, `monofont`\index{YAML!monofont} はメインのフォント, サンセリフ体, そしてタイプライタ体のフォントをそれぞれ指定するのに使えます.^[**訳注**: rmdja では YAML フロントマターでさらに欧文用フォントと和文用フォントを個別に指定できます.] 例えばこのように.

```yaml
mainfont: Arial
output:
  pdf_document: 
    latex_engine: xelatex
```

Beamer \index{Beamer}の文書は LaTeX 文書なので, Beamer でスライドを生成する時にもこれらのオプションを使用できます. 加えて, Pandoc は Beamer スライド用にいくつか追加オプションを提供してくれています. それらは https://pandoc.org/MANUAL.html#variables-for-beamer-slides で確認できます. 例えば `institute` オプションでoption\index{YAML!institute}著者の所属機関を指定することができます.

```yaml
---
output: beamer_presentation
institute: "ハッカーの大学"
---
```

## 表紙ページにロゴを置く {#latex-logo}

<!-- https://stackoverflow.com/questions/29389149/add-image-in-title-page-of-rmarkdown-pdf -->

LaTeX パッケージの **titling** \index{LaTeX パッケージ!titling} を表題ブロックを画像に変更\index{図!表紙ページ}するのに使うとができます. 以下は R ロゴ (`logo.jpg`) を表紙に配置する方法の例の全容です. 画像は LaTeX のサポートする形式 (例えば `jpg`, `png`, `pdf`) ならなんでも使えます.

`r import_example('latex-logo.Rmd')`

図\@ref(fig:latex-logo) がこの例の出力です.

```{r latex-logo, echo=FALSE, fig.cap="LaTeX の表紙ページにロゴを追加する", fig.align='center'}
knitr::include_graphics("images/latex-logo.png", dpi = NA)
```

LaTeX パッケージ (**titling**) を特に要求しない代替方法として, Markdown 構文を使って `title` フィールド\index{YAML!title}に画像を挿入する方法があります. 例えばこのように.

```yaml
title: |
  ![](logo.jpg){width=1in}  
  LaTeX のタイトルにロゴを追加する
```

この場合, 最初の例のように YAML フロントマターの `header-includes` フィールドは不要になります. 例からは見えませんが, `![](logo.jpg){width=1in}` の末尾にスペースが2つあることに注意してください. これは Markdown では改行を意味します(\@ref(linebreaks)節参照). 改行がない場合画像とタイトルは同じ行に現れてしまい, きっとそれはあなたの意図するものではないでしょう.

## LaTeX パッケージを追加で読み込む {#latex-extra}

<!-- https://tex.stackexchange.com/questions/171711/how-to-include-latex-package-in-r-markdown/452884#452884 -->

追加の LaTeX パッケージ を使うことで文書のスタイルに拡張的なカスタマイズが可能になります. 加えて **kableExtra**\index{R パッケージ!kableExtra} [@R-kableExtra]  のようないくつかのパッケージは R パッケージの関数を提供するために LaTeX に依存しているかもしれません. R でもよくあるように, これらの関数を使えるようになる前に R Markdown 文書内でパッケージを読み込む必要があります.

### LaTeX パッケージを読み込む {#loading-latex-packages}

`pdf_document` の YAML での設定 `extra_dependencies` オプション\index{出力オプション!extra\_dependencies} を使って追加の LaTeX パッケージを読み込めます. 中間ファイルの LaTeX 出力文書で読み込む LaTeX パッケージ\index{LaTeX パッケージ}のリストを与えることができます. 例えばこのように.

```yaml
---
title: "追加 LaTeX パッケージを使う"
output: 
  pdf_document:
    extra_dependencies: ["bbm", "threeparttable"]
---
```

パッケージ読み込み時のオプションを指定する必要があるなら, 第2のレベルを加えてオプションをリストとして与えられます. 例えばこのように.

```yaml
output: 
  pdf_document:
    extra_dependencies:
      caption: ["labelfont={bf}"]
      hyperref: ["unicode=true", "breaklinks=true"]
      lmodern: null
```

LaTeX に慣れた人にとっては, これは以下の LaTeX コードと同じです.

```tex
\usepackage[labelfont={bf}]{caption} 
\usepackage[unicode=true, breaklinks=true]{hyperref}
\userpackage{lmodern}
```

\@ref(latex-preamble)節で紹介した `includes` 引数に対し `extra_dependencies` 引数を使う利点は, 外部ファイルを読み込む必要がないため, Rmd 文書が自己完結的になりうるということです.

### パッケージの例 {#example-packages}

LaTeX には広範なコミュニティがあり [Comprehensive TeX Archive Network](https://ctan.org) (CTAN) 全体には 4,000 種類以上のパッケージがあります. ここにレポートに使えるかもしれない LaTeX パッケージの例をいくつか挙げます.

- [pdfpages](https://ctan.org/pkg/pdfpages): あなたの文書内に, 別の外部 PDF 文書からページを丸ごと持ってきて埋め込むことができます.
- [caption](https://ctan.org/pkg/caption): キャプションのサブタイトルを変更します. 例えば図のタイトルをイタリックや太字にできます.
- [fancyhdr](https://ctan.org/pkg/fancyhdr): 全てのページのラニングタイトル (欄外見出し) を変更できます.

## 図の位置を制御する {#figure-placement}

<!-- https://stackoverflow.com/questions/16626462/figure-position-in-markdown-when-converting-to-pdf-with-knitr-and-pandoc/17648350#17648350 -->
<!-- Some of the solutions adapted from https://texfaq.org/FAQ-floats. Link left here for future reference -->

LaTeX に共通の不満点の1つは図表の位置\index{図!位置}です. Microsoft ワードのような図がユーザーの指定した場所にそのまま置かれるワードプロセッサと違い, LaTeX は特定の組版ルールに反しないように図を配置しようとします. そうなると図はテキストで参照した場所から浮動 (フロート) するかもしれませn. この節では (図などの) フロート環境がどう機能し, その挙動をカスタマイズするためにどうオプションを与えるかについての予備知識を解説します.

### フロート環境 {#floating-environment}

LaTeX ではデフォルトではキャプションのある図は `figure` 環境で生成されます. 例えば Pandoc は以下の画像を含む Markdown コードを…,

```md
![This is a figure.](images/cool.jpg)
```

こう変換します.

```tex
\begin{figure}
  \includegraphics{images/cool.jpg}
  \caption{This is a figure.}
\end{figure}
```

`figure` 環境はフロート環境です. フロートの詳細な説明は https://en.wikibooks.org/wiki/LaTeX/Floats,_Figures_and_Captions で読むことができます. 要約するとフロートは, 図や表のようにページで区切られないコンテナとして使われます. 図表が現在のページの余白におさめられないと, LaTeX は次のページの先頭に配置します. 図が十分に縦長だと, テキストを数行分の余白が残っていたとしても,  次のページ全てを占有します. この挙動は, `\begin{figure}[b]` のように, `\begin{figure}`の後のブラケット内のいくつかの配置指定修飾子によって制御できます. 以下は使用可能な記号のリストです.

- `h`: フロートを**ここ** (here) に配置します. つまりソーステキスト上に現れるところとほぼ同じ位置です.
- `t`: そのページの**先頭** (top) に配置します.
- `b`: そのページの**末尾** (bottom) に配置します.
- `p`: フロート専用の特別な**ページ**に配置します.
- `!`: LaTex が「良い」フロートの位置を決定するための内部パラメータ上書きします.
- `H`: フロートを正確に LaTex コード上と同じ位置に配置します. **float** パッケージが必要です (`\usepackage{float}`).

これらの修飾子は併用できます. 例えば `!b` は LaTeX に図をページ末尾に置くよう矯正できます. デフォルトの挙動は `tbp` です. これは LaTeX が図をまずページ先頭に, ついで末尾に, そして独立したページに置こうとします.

### 図がフロートするのを防ぐ {"prevent-figures-from-floating}

多くのユーザは初めに, 伝統的なワードプロセッサの挙動を再現できるよう, 文書内を図が移動するのを防ぎたくなります. これを実現するには, まず LaTeX パッケージの **float**\index{LaTeX パッケージ!float} を読み込まなければなりません. YAML に以下の記述を含めることでできます.

```yaml
output: 
  pdf_document:
    extra_dependencies: ["float"]
```

チャンクオプション `fig.pos`\index{チャンクオプション!fig.pos} をフロートの挙動を制御するのに使えます. オプションの値 `!H` は文書でのいかなる移動も防ぎます. 以下の行を　R Markdown 文書の最初のコードチャンクに書くことで, 全てのチャンクがこの設定を持つように, これをデフォルトの挙動にすることもできます.

```{r, eval=FALSE}
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
```

一般論として, LaTeX の図のフロートを強制的にやめさせることをおすすめしません. よくある要望なので, 本書にこの解決策を盛り込んだのですが,^[関連するスタック・オーバーフローの質問 https://stackoverflow.com/q/16626462/559676 は 45,000 回以上閲覧されました.] LaTeX が図をフロートできないときにはいくつかの深刻な副作用が発生することがあります.

### フロートを後回しに強制する {#force-floats-forward}

<!-- https://tex.stackexchange.com/questions/15706/force-floats-to-be-typeset-after-their-occurrence-in-the-source-text -->

全てのフロートを固定するよう矯正することに代わる方法は, テキスト上でフロートが後回しになるよう矯正することです. これは関連するテキストが現れるよりも前に図がページの先頭に現れてしまうというよくある問題を排除できます. こうなるとレポートを読む流れが破壊されてしまいます. LaTeX パッケージの **flafter**\index{LaTeX パッケージ!flafter} を使って以下のようにすることで, 常に図がテキストより後に現れるよう強制できます.

```yaml
output: 
  pdf_document:
    extra_dependencies: ["flafter"]
```

### LaTeX 配置ルールを調整する (\*)

LaTeX 自体のフロート配置パラメータは全体として, あなたにとって「理にかなった」配置を邪魔しているかもしれません. 堅実などころか悪質なまでに. これらのデフォルト設定を表\@ref(tab:float-default)に示します.

```{r float-default, echo = FALSE}
floatOpts <- data.frame(
  `コマンド` = c("topfraction", "bottomfraction", "textfraction",
              "floatpagefraction", "topnumber", "bottomnumber",
              "totalnumber"),
  `概要` = c(
    "1ページに対するフロートの先頭からの最大割合",
    "1頁に対するフロートの末尾からの最大割合",
    "1ページのテキストの最小割合",
    "フロートが存在すべきページの最小割合",
    "ページ先頭のフロート最大数",
    "ページ末尾のフロート最大数",
    "1ページの最大フロート数"),
  `デフォルト` = c("0.7", "0.3", "0.2", "0.5", "2", "1", "3"),
  stringsAsFactors = FALSE
)
knitr::kable(floatOpts, caption = "LaTeX デフォルトのフロート設定")
```

LaTeX に図を動かさないよう努力してもらうために, これらの設定を変えることができます. LaTeX プリアンブルファイルに, 1ページのテキストの最小量を減らすような以下のコードを追加し, フロートが収まる余地を増やさせることができます.

```tex
\renewcommand{\topfraction}{.85}
\renewcommand{\bottomfraction}{.7}
\renewcommand{\textfraction}{.15}
\renewcommand{\floatpagefraction}{.66}
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{3}
\setcounter{totalnumber}{4}
```

これらの記述を `.tex` ファイルに追加したら, \@ref(latex-preamble)節で紹介した方法で LaTeX 文書のプリアンブルで読み込ませることができます.

## LaTeX で複数の図をまとめる {#latex-subfigure}

複数の画像を1つの画像環境に含めたいときがあるかもしれません. 複数の画像を1つの環境に並べ, それぞれのサブキャプションを与えることで, 複数の図 (サブ図) をまとめる\index{図!複数の図をまとめる}ことが達成できます.
Sometimes you may want to include multiple images in a single figure environment. Sub-figures\index{figure!sub-figures} allow us to achieve this by arranging multiple images within a single environment and providing each with its own sub-caption.

図をまとめるには LaTeX パッケージの **subfig**\index{LaTeX package!subfig} が必要です. `pdf_document` 出力の YAML オプションの `extra_dependencies`\index{output option!extra\_dependencies} で読み込ませることができます. 例えばこのように.

```yaml
---
output:
  pdf_document:
    extra_dependencies: "subfig"
---
```

コードチャンクからの全てのプロットを並べるために, チャンクオプション `fig.cap`\index{チャンクオプション!fig.cap} (環境全体のキャプション)  と `fig.subcap`\index{チャンクオプション!fig.subcap} (サブ図のためのキャプションの文字列ベクトル) を使わなければなりません. 最良の選択のために, 以下のような選択肢も使用できます.


- `fig.ncol`\index{チャンクオプション!fig.ncol}: サブ図の列の数です. デフォルトでは全てのグラフが単一の行に並べられます. これは複数の行に分けられます.

- `out.width`\index{チャンクオプション!out.width}: 個別のグラフの出力幅です. 通常はこれを `100%` を列の数で割ったものに設定しますが. 例えば2つグラフがあるなら,  `out.width` は `50%` 以下にすべきです. そうしないとグラフはページの外枠をはみ出すかもしれません.

以下は具体例の1つです.

```yaml
---
output:
  pdf_document:
    extra_dependencies: "subfig"
---
```

````md
```{r, fig.cap='Figure 1', fig.subcap=c('(a)', '(b)', '(c)')}`r ''`
plot(1:10)
plot(cars, pch = 19)
boxplot(Sepal.Width ~ Species, data = iris)
```
````

この出力を図\@ref(fig:latex-subfig)に示します. 簡潔さのため, 上記の例は `fig.ncol = 2`, `out.width = "50%"`, `fig.align = "center"` や長いキャプションなどのチャンクオプションをいくつか省略しています.

```{r latex-subfig, fig.cap="複数の図を含む単一の figure 環境の例", echo=FALSE}
knitr::include_graphics("images/latex-subfig.png", dpi = NA)
```

## Unicode 文字を含む文書をレンダリングする {#latex-unicode}


```latex
! Package inputenc Error:
  Unicode char \u8: not set up for use with LaTeX.
```

もしこのようなエラーにでくわしたら, おそらくデフォルトの LaTeX エンジン `pdflatex` を使って文書 (中間ファイルの `.tex` ) を PDF へレンダリングしているのでしょう. `pdflatex` はそのファイルにある何らかの Unicode 文字を処理できません. もしこのようなケースであれば, `xelatex` か `lualatex` へ切り替える\index{出力オプション!latex\_engine}ことになるでしょう. 例えばこのように.

```yaml
output:
  pdf_document:
    latex_engine: xelatex
```

他の文書出力フォーマットの LaTeX エンジンも変更できるでしょう. 特に `bookdown::pdf_document2` や `tufte::tufte_handout` といった `pdf_document` ベースのものは. 例えばこのように.

```yaml
output:
  bookdown::pdf_document2:
    latex_engine: lualatex
  tufte::tufte_handout:
    latex_engine: xelatex
```

## Generate a LaTeX fragment {#latex-fragment}

If you work primarily with pure LaTeX documents, you may still find R Markdown useful. Sometimes it may be more convenient to write in R Markdown and convert the document to a LaTeX fragment\index{LaTeX!fragment}, which can be included in other LaTeX documents.

When you render an Rmd document to LaTeX, it generates a full LaTeX document that includes the `\documentclass{}`, `\begin{body}`, and `\end{body}`. A LaTeX fragment is basically the body of a full LaTeX document. To render a LaTeX fragment, you may use the `latex_fragment` output format, e.g.,

```yaml
---
output: latex_fragment
---
```

This will render a `.tex` file, e.g., `foo.Rmd` will render `foo.tex`, and you can use `\input{foo.tex}` to include this fragment in another LaTeX document.

## Add custom headers and footers (\*) {#latex-header}

<!-- https://stackoverflow.com/questions/25329375/creating-a-footer-for-every-page-using-r-markdown -->
<!-- https://tex.stackexchange.com/questions/139139/adding-headers-and-footers-using-pandoc -->

The LaTeX package **fancyhdr**\index{LaTeX package!fancyhdr} has provided several commands to customize the header and footer lines of your document. For a more complete guide, please refer to the full documentation at https://ctan.org/pkg/fancyhdr. To begin with, we must load the package. Then we can change the header style, e.g.,

```tex
\usepackage{fancyhdr}
\pagestyle{fancy}
```

The package offers three different interfaces, but we will use the commands `\fancyhead` and `\fancyfoot`. The syntax for the formatting is `\fancyhead[selectors]{output text}`, whereby the selectors state the part of the header that we wish to customize. We can use the following selectors for the page locators:

- **E** for even pages
- **O** for odd pages
- **L** for the left side
- **C** for the center
- **R** for the right side

For example, `\fancyhead[LE,RO]{Your Name}` will print the text "Your Name" on the left side of the header for even pages, and the right side for odd pages. We can combine this with additional LaTeX commands to extract details from our document for each page:

- `\thepage`: the number of the current page.
- `\thechapter`: the number of the current chapter.
- `\thesection`: the number of the current section.
- `\chaptername`: the word "Chapter" in English, or its equivalent in the current language, or the text that the author specified by redefining this command.
- `\leftmark`: the name and number of the current top-level structure in uppercase letters.
- `\rightmark`: the name and number of the current next to top-level structure in uppercase letters.

Below is some example LaTeX code that you can add to the preamble using the methods introduced in Section \@ref(latex-preamble):

```latex
\usepackage{fancyhdr}
\pagestyle{fancy}
% center of header
\fancyhead[CO,CE]{Your Document Header}
% center of footer
\fancyfoot[CO,CE]{And this is a fancy footer}
% page number on the left of even pages and right of odd pages
\fancyfoot[LE,RO]{\thepage}
```

<!-- https://stackoverflow.com/questions/30922602/creating-a-footer-for-every-page-including-first-using-r-markdown -->

By default, headers and footers will not be displayed on the first page of your PDF document. If we wish to show our footer on the front page, we must include an additional line `\fancypagestyle{plain}{\pagestyle{fancy}}`.

## Use a custom Pandoc LaTeX template (\*) {#latex-template}

Pandoc converts Markdown to LaTeX through a template\index{template!LaTeX}. The template is a LaTeX file containing Pandoc\index{Pandoc} variables, and Pandoc will replace these variables with their values. Below is a simple template that only contains a single variable `$body$`:

```tex
\documentclass{article}
\begin{document}
$body$
\end{document}
```

The value of `$body$` is the LaTeX code generated from the body of the Markdown document. For example, if the body text is `Hello **world**!` in Markdown, the value of `$body$` will be `Hello \textbf{world}!`.

If the LaTeX customization methods in Sections \@ref(latex-preamble), \@ref(latex-variables), and \@ref(latex-extra) are not enough for you, you may try to use a custom template instead. A template allows you to use arbitrary LaTeX code in it, and hence is much more flexible. To use a template, include the path of the template in the `template` option\index{output option!template} of `pdf_document`, e.g.,

```yaml
output:
  pdf_document:
    template: my-template.tex
```

The default LaTeX template of Pandoc can be found at https://github.com/jgm/pandoc/tree/master/data/templates (named `default.latex`). If you want to create your own template, you may want to start with this template.

For the full list of Pandoc variables and their meanings (such as `$body$` and `$title$`), see Pandoc's manual at https://pandoc.org/MANUAL.html#templates. You can also use arbitrary custom variables, which are typically passed to the template from the YAML metadata. If you want to learn by examples, you may take a look at the **MonashEBSTemplates** package\index{R package!MonashEBSTemplates} (https://github.com/robjhyndman/MonashEBSTemplates), which has provided several custom LaTeX templates. These templates are under the `inst/rmarkdown/templates/*/resources/` directories (here `*` denotes the template names). For example, the template for the output format `MonashEBSTemplates::memo` allows you to use a variable `branding` in the YAML metadata to control whether to include the brand logo of Monash University. This is achieved by an `if` statement in the template that looks like this:

```latex
$if(branding)$%
\includegraphics[height=1.5cm]{monash2}
\vspace*{-0.6cm}
$else$
\vspace*{-1cm}
$endif$
```

## Write raw LaTeX code {#raw-latex}

By default, Pandoc will preserve raw LaTeX code\index{LaTeX!raw code} in Markdown documents when converting the document to LaTeX, so you can use LaTeX commands or environments in Markdown. However, sometimes your LaTeX code might be too complex for Pandoc to parse, in which case Pandoc will treat the content as normal Markdown. The consequence is that special LaTeX characters may be escaped, e.g., Pandoc may convert a backslash `\` to `\textbackslash{}`.

To make sure that Pandoc does not touch the raw LaTeX code in your Markdown document, you may wrap the code in a fenced code block with the attribute `=latex`, e.g.,

````md
```{=latex}
\begin{tabular}{ll}
A & B \\
A & B \\
\end{tabular}
```
````

Do not forget the equal sign before `latex`, i.e., it is `=latex` instead of `latex`. This feature requires a Pandoc version higher than 2.0 (check `rmarkdown::pandoc_version()`).

## For hardcore LaTeX users (\*) {#latex-hardcore}

R Markdown is certainly not the best possible document format for authoring or typesetting documents. Simplicity is both its advantage and disadvantage. LaTeX is much more powerful than Markdown in terms of typesetting at the price of more commands to be typed. If typesetting is of much higher priority to you and you are comfortable with using all kinds of LaTeX commands and environments, you can just use pure LaTeX code instead of Markdown to write the whole document.

The **knitr** package supports a variety of source document formats, including but not limited to R Markdown. Below is an example of intermingling R code with pure LaTeX code:

`r import_example('knitr.Rnw')`

The filename usually has the extension `.Rnw`\index{LaTeX!Rnw}, e.g., the above file is `latex.Rnw`. The idea is the same but the syntax for writing R code chunks and inline R expressions is different. An R code chunk starts with `<<>>=` (with optional chunk options inside the angle brackets) and ends with `@`. An inline R expression is written in `\Sexpr{}`.

The function `knitr::knit()` can compile an `Rnw` document to a LaTeX (`.tex`) output file, which can be further compiled to PDF through your LaTeX tools such as `pdflatex`. You can also use `knitr::knit2pdf()`\index{knitr!knit2pdf()} to compile `Rnw` to PDF in one step. If you use RStudio, you can hit the `Compile PDF` button on the toolbar. Please note that the default method to compile Rnw documents is through Sweave, and you may want to change it to **knitr** (see the post http://stackoverflow.com/q/27592837/559676 for how to do that).

An `Rnw` document gives you the full power of LaTeX. This could be your last resort if there are typesetting problems that are really difficult to solve in Markdown. However, before you drop Markdown, we would like to remind you of the fact that a custom Pandoc LaTeX template may also be helpful (see Section \@ref(latex-template)).
